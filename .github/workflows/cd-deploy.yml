# name: CD - Deploy to Azure

# on:
#   push:
#     branches:
#       - azure-deployment-production

# env:
#   ACR_NAME: <YOUR_ACR_NAME>
#   IMAGE_NAME: recotrack-api
#   RESOURCE_GROUP: audioplatform-rg-dev-centralindia
#   CONTAINER_APP_NAME: recotrack-api-app
#   LOCATION: centralindia

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Azure Login
#         uses: azure/login@v2
#         with:
#           creds: ${{ secrets.AZURE_CREDENTIALS }}

#       - name: Login to ACR
#         run: |
#           az acr login --name $ACR_NAME

#       - name: Build Docker image
#         run: |
#           docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }} .

#       - name: Push Docker image
#         run: |
#           docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}

#       - name: Create Container App (if not exists)
#         run: |
#           az extension add --name containerapp --upgrade || true

#           if ! az containerapp show \
#             --name $CONTAINER_APP_NAME \
#             --resource-group $RESOURCE_GROUP >/dev/null 2>&1; then

#             az containerapp up \
#               --name $CONTAINER_APP_NAME \
#               --resource-group $RESOURCE_GROUP \
#               --location $LOCATION \
#               --image $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }} \
#               --target-port 8080 \
#               --ingress external
#           else
#             az containerapp update \
#               --name $CONTAINER_APP_NAME \
#               --resource-group $RESOURCE_GROUP \
#               --image $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}
#           fi


name: CD - Deploy to Azure App Service

on:
  push:
    branches:
      - azure-deployment-production

env:
  ACR_NAME: routinetrackerwebapplication   # your ACR login server name (lowercase)
  IMAGE_NAME: recotrack-api
  RESOURCE_GROUP: RecoTrackApi
  WEBAPP_NAME: RoutienTrackerWebPortal

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ✅ Azure login
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ✅ Login to ACR
      - name: Login to ACR
        run: |
          az acr login --name $ACR_NAME

      # ✅ Build image
      - name: Build Docker image
        run: |
          docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }} .

      # ✅ Push image
      - name: Push Docker image
        run: |
          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}

      # ✅ Configure Web App to use new image
      - name: Deploy to Azure Web App
        run: |
          az webapp config container set \
            --name $WEBAPP_NAME \
            --resource-group $RESOURCE_GROUP \
            --docker-custom-image-name $ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }} \
            --docker-registry-server-url https://$ACR_NAME.azurecr.io